---
title: "Population and Employment"
author: "Greg Macfarlane"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r setup}
library(knitr)
opts_chunk$set(fig.width=8, fig.height=6)
```

I have been tasked with coming up with a convenient method for digesting the 
results of a SWIM model run. I think the best thing to do is to create a series
of helper functions that will create plots or calculate metrics on tables pulled
directly from the database. I have wrapped these functions in an Rpackage that
I am calling `swimr`. 


```{r load_swimr}
library(swimr)
```

The package relies on `dplyr`, `ggplot2`, and other modern R packages. These
should be installed by default, but I use them for lots of things so I'll load
them here.

```{r load_libraries, message=FALSE, warning=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
```

One advantage of the `dplyr` package is that it can work on the SQLite database
directly. For more information, see the `dplyr`
[vignette](http://cran.r-project.org/web/packages/dplyr/vignettes/databases.html).

```{r point_to_db}
db_path <- "~/Documents/projects/swim/midjuly_swim.db"
db <- src_sqlite(db_path)
db
```


# Population and Employment
To figure out what was going on in the output, I rebuilt the county-level
population and employment plots Alex showed us in the last group call.

The source data for these plots comes from two different tables in the database;
`AZONE` has the zone-level socioeconomic data, and `ALLZONES` has the
information about the zone, including which county the zone is in. We can pull
the variables we need from each of these tables, and process it as neccessary.

```{r azone_data}
# Pull land use data
azone_data <- tbl(db, "AZONE") %>%
  select(AZONE, POPULATION, EMPLOYMENT, TOTALHHS, TSTEP) %>%
  # join information for county and state
  left_join(
    tbl(db, "ALLZONES") %>%
      select(AZONE = Azone, county = COUNTY, state = STATE)
  ) 
azone_data
```

At this point, `azone_data` doesn't exist as a table in memory, but instead
is a list of instructions for `db` to create this table on demand. We now want 
to aggregate the socioeconomic variables up to the county level in each year,
and compare these model results to the county control totals.

```{r county_data}
county_data <- azone_data %>%
  group_by(county, state, TSTEP) %>%
  summarise(
    population = sum(POPULATION),
    employment = sum(EMPLOYMENT),
    totalhh = sum(TOTALHHS)
  ) %>%
  mutate(year = as.numeric(TSTEP) + 1990)
county_data
```

At this point, there are two functions that we can execute on this data table. 
The first is to create a table of an economic variable aggregated to a given
level at each year, with the function `yearly_summary()`

```{r yearly_summary}
yearly_summary(county_data, "state", "population")
yearly_summary(county_data, "county", "employment")
```

The `plot_sevar()` function makes a plot like Alex's, comparing population and 
employment in a county. It draws control tables from a `data_frame` included
with the package. You can also compare multiple counties.


```{r plot_sevar}
plot_sevar(county_data, "Baker")
plot_sevar(county_data, c("Multnomah", "Washington", "Clackamas"))
```

# Traffic

```{r validation}
plot_validation(db)
```


## VMT/VHT
```{r vmt}
plot_vmt(db)
```

```{r vht}
plot_vht(db)
```

## Congestion
```{r congested}
plot_pct_cong(db)
```


